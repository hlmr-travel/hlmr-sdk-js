name: NPM Token Health Check

on:
  schedule:
    # VÃ©rification mensuelle le 1er de chaque mois Ã  9h UTC
    - cron: '0 9 1 * *'
    # Rappels spÃ©cifiques pour l'expiration du 24 fÃ©vrier 2026
    - cron: '0 9 24 11 *'  # 24 novembre (3 mois avant)
    - cron: '0 9 24 1 *'   # 24 janvier (1 mois avant)
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

env:
  TOKEN_EXPIRY_DATE: "2026-02-24"
  TOKEN_NAME: "NPM_TOKEN pour SDK Public"

jobs:
  check-npm-token:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Test NPM authentication
        id: npm-test
        run: |
          echo "ğŸ” Test d'authentification NPM..."
          if npm whoami; then
            echo "auth_status=success" >> $GITHUB_OUTPUT
            echo "âœ… Token NPM valide"
            USER=$(npm whoami)
            echo "npm_user=$USER" >> $GITHUB_OUTPUT
          else
            echo "auth_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Token NPM invalide ou expirÃ©!"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Test organization access
        if: steps.npm-test.outputs.auth_status == 'success'
        id: org-test
        run: |
          echo "ğŸ¢ Test d'accÃ¨s Ã  l'organisation @hlmr..."
          if npm org ls hlmr; then
            echo "org_access=success" >> $GITHUB_OUTPUT
            echo "âœ… AccÃ¨s Ã  l'organisation @hlmr confirmÃ©"
          else
            echo "org_access=failed" >> $GITHUB_OUTPUT
            echo "âŒ Pas d'accÃ¨s Ã  l'organisation @hlmr"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Calculate days until expiry
        id: expiry-calc
        run: |
          EXPIRY_DATE="${{ env.TOKEN_EXPIRY_DATE }}"
          CURRENT_DATE=$(date +%Y-%m-%d)
          EXPIRY_TIMESTAMP=$(date -d "$EXPIRY_DATE" +%s)
          CURRENT_TIMESTAMP=$(date -d "$CURRENT_DATE" +%s)
          DAYS_UNTIL_EXPIRY=$(( (EXPIRY_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
          echo "days_until_expiry=$DAYS_UNTIL_EXPIRY" >> $GITHUB_OUTPUT
          echo "ğŸ“… Jours jusqu'Ã  expiration: $DAYS_UNTIL_EXPIRY"
          
          if [ $DAYS_UNTIL_EXPIRY -le 30 ]; then
            echo "urgency=critical" >> $GITHUB_OUTPUT
          elif [ $DAYS_UNTIL_EXPIRY -le 90 ]; then
            echo "urgency=warning" >> $GITHUB_OUTPUT
          else
            echo "urgency=info" >> $GITHUB_OUTPUT
          fi
          
      - name: Create urgent reminder issue
        if: steps.npm-test.outputs.auth_status == 'failed' || steps.expiry-calc.outputs.urgency == 'critical'
        uses: actions/github-script@v6
        with:
          script: |
            const authStatus = '${{ steps.npm-test.outputs.auth_status }}';
            const daysUntilExpiry = '${{ steps.expiry-calc.outputs.days_until_expiry }}';
            const expiryDate = '${{ env.TOKEN_EXPIRY_DATE }}';
            
            let title, body, labels;
            
            if (authStatus === 'failed') {
              title = 'ğŸš¨ URGENT: Token NPM invalide ou expirÃ©';
              labels = ['urgent', 'infrastructure', 'npm-token'];
              body = `
              ## âš ï¸ Action immÃ©diate requise : Token NPM invalide
              
              Le token NPM utilisÃ© pour la publication automatique du SDK public est **invalide ou expirÃ©**.
              
              ### ğŸ”¥ Impact :
              - âŒ Impossible de publier de nouvelles versions
              - âŒ Les GitHub Actions de publication Ã©choueront
              - âŒ Pas d'accÃ¨s Ã  l'organisation @hlmr
              
              ### ğŸ“‹ Actions Ã  effectuer IMMÃ‰DIATEMENT :
              1. ğŸ”‘ CrÃ©er un nouveau Granular Access Token sur [npmjs.com](https://www.npmjs.com/settings/tokens)
              2. âš™ï¸ Configurer les permissions pour l'organisation @hlmr
              3. ğŸ”„ Mettre Ã  jour le secret \`NPM_TOKEN\` dans [GitHub Secrets](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions)
              4. âœ… Tester avec une publication ou dÃ©clencher ce workflow manuellement
              5. ğŸ—‘ï¸ RÃ©voquer l'ancien token sur npmjs.com
              
              ### ğŸ”— Liens utiles :
              - [NPM Access Tokens](https://www.npmjs.com/settings/tokens)
              - [GitHub Secrets](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions)
              - [Documentation rotation tokens](../GITHUB_ACTIONS_SETUP.md)
              `;
            } else {
              title = \`ğŸš¨ Token NPM expire dans \${daysUntilExpiry} jours\`;
              labels = ['urgent', 'infrastructure', 'npm-token', 'expiration'];
              body = \`
              ## â° Token NPM expire bientÃ´t !
              
              Le token NPM pour le SDK public expire le **\${expiryDate}** (dans \${daysUntilExpiry} jours).
              
              ### ğŸ“‹ Actions Ã  effectuer avant expiration :
              1. ğŸ”‘ CrÃ©er un nouveau Granular Access Token sur [npmjs.com](https://www.npmjs.com/settings/tokens)
              2. âš™ï¸ Configurer les permissions pour l'organisation @hlmr
              3. ğŸ§ª Tester le nouveau token localement : \`npm whoami\`
              4. ğŸ”„ Mettre Ã  jour le secret \`NPM_TOKEN\` dans GitHub
              5. âœ… DÃ©clencher ce workflow pour vÃ©rifier
              6. ğŸ—‘ï¸ RÃ©voquer l'ancien token aprÃ¨s confirmation
              
              ### ğŸ’¡ Recommandations :
              - CrÃ©er le token avec une durÃ©e maximale (1-2 ans)
              - Choisir une date d'expiration mÃ©morable
              - Documenter la nouvelle date d'expiration
              
              ### ğŸ”— Liens utiles :
              - [NPM Access Tokens](https://www.npmjs.com/settings/tokens)
              - [GitHub Secrets](https://github.com/\${context.repo.owner}/\${context.repo.repo}/settings/secrets/actions)
              \`;
            }
            
            // VÃ©rifier si un issue similaire existe dÃ©jÃ 
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'npm-token'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });
              console.log('âœ… Issue de rappel crÃ©Ã©');
            } else {
              console.log('â„¹ï¸ Un issue de rappel existe dÃ©jÃ ');
            }
            
      - name: Create warning reminder issue
        if: steps.npm-test.outputs.auth_status == 'success' && steps.expiry-calc.outputs.urgency == 'warning'
        uses: actions/github-script@v6
        with:
          script: |
            const daysUntilExpiry = '${{ steps.expiry-calc.outputs.days_until_expiry }}';
            const expiryDate = '${{ env.TOKEN_EXPIRY_DATE }}';
            
            // VÃ©rifier si un issue similaire existe dÃ©jÃ 
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'npm-token'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âš ï¸ Rappel: Token NPM expire dans ${daysUntilExpiry} jours`,
                body: `
                ## ğŸ“… Rappel de rotation du token NPM
                
                Le token NPM pour le SDK public expire le **${expiryDate}** (dans ${daysUntilExpiry} jours).
                
                ### ğŸ“‹ Planification recommandÃ©e :
                - **Maintenant** : PrÃ©parer la rotation
                - **Dans 2 semaines** : CrÃ©er le nouveau token
                - **1 semaine avant** : Effectuer la rotation
                
                ### ğŸ”§ ProcÃ©dure de rotation :
                1. CrÃ©er un nouveau Granular Access Token
                2. Tester localement
                3. Mettre Ã  jour GitHub Secrets
                4. VÃ©rifier les publications
                5. RÃ©voquer l'ancien token
                
                ### ğŸ”— Ressources :
                - [NPM Tokens](https://www.npmjs.com/settings/tokens)
                - [GitHub Secrets](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions)
                `,
                labels: ['infrastructure', 'npm-token', 'reminder']
              });
            }
            
      - name: Log success status
        if: steps.npm-test.outputs.auth_status == 'success' && steps.expiry-calc.outputs.urgency == 'info'
        run: |
          echo "âœ… Token NPM en bonne santÃ©"
          echo "ğŸ‘¤ Utilisateur NPM: ${{ steps.npm-test.outputs.npm_user }}"
          echo "ğŸ¢ AccÃ¨s organisation: ${{ steps.org-test.outputs.org_access }}"
          echo "ğŸ“… Expire dans: ${{ steps.expiry-calc.outputs.days_until_expiry }} jours"

